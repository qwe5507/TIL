
### S3란?
- `Simple Storage Service`
- 객체 스토리지
- 파일 업로드, 다운로드, 검색 가능 
- 무제한 용량
- 다양한 인증 / 권한 부여제공

### S3 특징
- 리전 기반 서비스
  - 두 개 이상의 가용영역(AZ)으로 이루어져 있다.
    - 데이터센터가 분산되어 있다. = 안정적이다.
- 매우 안전한 내구도를 가진다.
  - 99.999999999% 내구도를 가짐
- 상대적으로 빠르지는 않다.
- CDN과 연동 가능 
  - 클라우드 프론트와 연동해서 CDN기능 지원 가능
- Static web page 기능 지원 
  - 간단한 웹페이지 기능 지원
- 필요에 따라 버저닝(verseioning)기능 사용 가능 
  - 같은 파일을 덮어씌울떄 내부적으로 버저닝기능 활성화 가능
- 옵션에 따라 비용이 절감 가능
  - 데이터가 많을때는 옵션 선택이 굉장히 중요하다.
  - AI가 옵션을 선택해주는 기능이 있음.

### S3 사용 예
- 클라우드 저장소 (개인 파일 보관, 구글 드라이브처럼 사용 가능)
  - 클라우드 저장소의 용도로 사용하는 경우는 흔치 않음.
- `서비스의 대용량 파일 저장소` - 이미지, 동영상, 빅데이터 (ex: 넷플릭스)
  - S3를 가장 많이 사용하는 경우
  - 클라우드 프론트와 연동하여 CDN방식으로 클라이언트에게 파일을 제공한다.
- 서비스 로그 저장 및 분석
  - 로그를 EC2에 저장하는 것은 안티패턴
  - 로그는 안전하고 저렴한 S3에 저장하는게 좋다.
  - CloudWatch Logs라는 서비스를 사용할 수도있는데, 결국 s3에 저장되는 점은 같다.
  - `S3에 저장하는게 좋은 이유` 
    - 비용 : 서버의 디스크를 EBS라고하는데 그것보다 S3가 저렴
    - 안정성 : EBS보다 S3가 훨씬 안정적이다.
- AWS 아데나를 이용한 빅데이터 업로드 및 분석
  - S3에 SQL쿼리 같은걸 날려서 데이터를 가져올 수있음.
- 서비스 사용자의 데이터 업로드 서버 (이미지 서버, 동영상 서버)
- `중요한 파일은 EC2의 SSD (EBS)에 저장하지 말고 S3에 저장하자`
  - EBS는 1%정도 불 안정성이 있음.
  - S3는 99.99999999안정
- glacier와의 연동으로 비용 절감 및 규정 준수 가능
  - 자주사용하지 않는 데이터 (= glacier) 를 저장하는데 용이
  - 금융분야의 pci dss에 위배되는 데이터를 저장하는데 용이

---
### S3용어

### 버킷
- 객체(파일)을 저장하기 위한 컨테이너
- 버킷의 이름은 글로벌하게 유니크 해야 한다.
- 오브젝트: 버킷은 오브젝트 저장소라고 하는데 일반적으로 오브젝트 = 파일이다.
- S3 버킷의 모든 오브젝트들은 고유한 URL을 가진다.

### key, Version, Prefix
- Key: 버킷안의 오브젝트를 식별하는 데 사용
  - 파일이름 + Prefix
- Version: 버킷 속성에서 versioning을 활성화하면 사용 가능
- Prefix: 버킷 안에 폴더를 생성할 수 있는데 폴더는 사실 키의 접두사(prefix)이다.
- S3에는 폴더 개념은 사실 없다.

```
  https://honux-inf.s3.amazonaws.com/2021-1/avartar.png
```
- 버킷이름: honux-inf
- prefix (폴더): 2021-01, 파일명: avatar.png
- key: 2021-1/avatar.png
```
 https://honux-inf.s3.amazonaws.com/2021-1/avartar.png/{버전}
```
- Versioning기능을 사용하면 위와 같이 url끝에 쿼리스트링에 버전을 추가하여 파일을 식별하게 된다.  

### S3에 권한 제어
- ACL (Access Control List) : 객체마다 ACL로 권한 지정 가능. 주로 간단한 제어에 사용
- Buket Policy: IAM Policy와 유사한 문법. ACL보다 복잡하고 세부적으로 지정 가능
- IAM을 이용한 제어: IAM 사용자에게 버킷 접근 권한을 주기 위해 사용
- PresignedURL: URL을 이용해 임시 권한을 부여하는 기능. 개발 할 때 매우 유용함

### AWS S3 CLI
- `aws configure`
  - aws 인증
- `aws s3 ls`
  - s3 버킷 리스트 조회 
- `aws s3 mb s3://{버킷명}`
  - s3 버킷 생성
- `aws s3 cp {로컬파일명} s3://{버킷명}/{파일명}`
  - 리눅스 명령어와 동일
  - 업로드 
  - 순서를 바꿔서 다운로드 가능 

- `aws s3 rm s3://{버킷명}/{파일명}`
  - 파일 삭제 
  - 리눅스 명령어와 동일 
  - 삭제는 바로 적용 안될 수도 있음.
- `aws s3 sync {현재디렉토리} {s3버킷_및 _경로}`
  - 동기화 
  - 파일 하나씩 업로드/다운로드 할 필요없이 한번에 동기화 
  - 업로드/다운로드에 모두 사용가능
- `aws s3api put-object-acl --bucket 버킷이름 --key 객체경로 --acl {지정된ACL}`
  - 객체 ACL 설정
  - EX: `aws s3api put-object-acl --bucket www.simpson.ip --key hello/image003.png --acl public-read`
    - public-read : 퍼블릭 읽기전용

### Static web hosting
- S3페이지를 웹서버처럼 사용 가능 
- 정적 페이지만 가능, 동적페이지X
- CDN 서비스인 CloudFront와 연동시 성능 및 보안에 이점 
- Route53을 이용해서 DNS연동 가능 
  - 이 경우 버킷 이름이 도메인 이름과 같아야 함
  - Route53 - CloudFront - S3 연동으로 구성하는 것이 일반적이다.

### Multipart upload
- CLI 또는 SDK 사용시: 단일 PUT 사용으로 5GB까지 업로드 가능
  - 단일 파일 업로드
  - aws에서 제공하는 put메소드인 파일 업로드 api를 이용 
- 관리 콘솔: 160GB 제한
- multipart upload: CLI 또는 SDK 사용 가능, 최대 5TB까지 가능
- 일반 적으로 단일 파일 업로드나 관리 콘솔로 처리 가능하다.
- `multipart upload를 사용하는 이유 `
  1. 성능
  2. 용량초과
  > 추가비용 발생

### S3 요금 
- S3는 아래 3가지의 비용이 청구된다.
  - 객체 저장 비용
  - 네트워크 전송 비용 
  - API 요청 비용
- 비용 알람 설정 필수
- 스토리지 클래스와 라이프 사이클 쓰면 비용을 절감할 수 있다.

### 스토리지 클래스
- 객체(파일)마다 스토리지 클래스 설정 가능
- 기본적으로 Standard
- 각 스토리지 클래스마다 특성이 다르기 때문에 잘 알고 사용해야 한다.
- IA (Infrequent Access)의 경우 저장 비용은 저렴하고 요청 비용이 비싸다.
- 스토리지 요금이 많이 나온다면 AI 티어링을 고려해 보자.
  - 스토리지 클래스 선택에 어려움이 있거나, 대용량 파일을 사용하는 경우
- glacier는 cold data 저장용, 데이터 요청시 4시간 정도 걸린다.
  - 복원 기간을 정하고, 그기간 만큼만 복원하여 사용 가능 하다
  - 잘못 사용하면 더 비싸짐
  - 사용 예 
    - 보안 규정때문에 사용
    - 용량이 아주크면서, 오래 사용하지 않는 경우
- One Zone IA
  - 가용영역을 하나만 사용
    - 가용성 99.5%
  - 요금은 가장 저렴하다.
- https://aws.amazon.com/ko/s3/storage-classes/
  - 문서 참고하여 선택

### 라이프 사이클
- 파일 생성후 라이프 사이클 규칙을 지정하고 수명 관리 가능
- 비용 절감 및 규정 준수(Compliance) 에 유효하게 사용함
- 로그 파일 관리, 민감 정보 보관 및 폐기 등에 유용함
- ex) 로그 파일 수명 관리
  - 최초 생성 Standard형
  - 30일 후 접근 빈도가 적어질 것 같으니, onezone_IA 로 지정
  - 또 30일 후 접근 빈도가 더 적어질 것 같으니 glacier로 지정
  - 6개월이 지나면 삭제
- PCI DSS등등.. 국내 보안 규정 준수에도 용이 하게 사용된다.
  - `몇 개월만 보관`같은 규정 준수

### Versioning(버전 관리)
- 버킷 속성에서 버전 관리를 활성화하면 쉽게 사용 가능
- 변경내용을 추적할 수 있으므로 매우 편리
- 비용에 조심하자
  - 100MB 파일을 5번 수정하면, 내부적으로 500MB이기 떄문에  
- 활성화하면 라이프 사이클 관리 기능이 다소 복잡해진다
- 꼭 필요한 중요 파일만 사용

---
추가 학습 필요

### Eventual Consistency
- 최종 일관성을 제공한다.
- `특정 요청에 대한 응답의 일관성을 언젠가는 보장하나, 보장할때까지 일정 시간이 소요될 수 있음.`
- 같은 key로 된 Object를 덮어쓰기 하고나서, 빠른 시간에 GET요청을 했을때 최종 일관성이 보장되기 전까지 예전 데이터를 반환 하 수있음.

### Strong Consistency
### Update – Strong Read-After-Write Consistency
- Eventual Consistency보다 더 강한 일관성을 제공한다.
- `쓰기 직후 바로 변경사항을 볼 수 있는(읽기) 기능`
- https://aws.amazon.com/ko/blogs/aws/amazon-s3-update-strong-read-after-write-consistency/
